<!DOCTYPE html>
<html lang="pt" dir="ltr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Tasty Pizza & Burger ‚Äî Black Friday Menu</title>

<meta property="og:title" content="Tasty Pizza & Burger ‚Äî Black Friday Menu">
<meta property="og:description" content="Hot deals, fresh pizzas & smashing burgers. Order on WhatsApp in one tap.">
<meta property="og:type" content="website">
<meta property="og:url" content="https://example.com/">
<meta property="og:image" content="https://example.com/og-tasty.jpg">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">
<meta name="twitter:card" content="summary_large_image">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#ffffff; --card:#ffffff; --soft:#f7f7f8;
  --ink:#111114; --muted:#5f6368;
  --primary:#ffbc0d; --accent:#db0007;
  --ring:0 0 0 3px rgba(255,188,13,.35);
  --radius:18px; --border:#e5e7eb;
}
html[data-theme="dark"]{
  --bg:#0b0b0d; --card:#141417; --soft:#1b1b20;
  --ink:#f5f5f6; --muted:#b0b0b6;
  --primary:#e11d48; --accent:#f5c542;
  --ring:0 0 0 3px rgba(245,197,66,.28);
  --border:#232327;
}
*{box-sizing:border-box} html,body{margin:0;height:100%}
body{background:var(--bg);color:var(--ink);font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
a{color:var(--accent);text-decoration:none}
.container{max-width:1100px;margin:0 auto;padding:18px}

/* Topbar */
header{position:sticky;top:0;z-index:50;backdrop-filter:saturate(140%) blur(6px);
  background:linear-gradient(180deg, color-mix(in hsl, var(--card) 96%, transparent), color-mix(in hsl, var(--card) 88%, transparent));
  border-bottom:1px solid var(--border)}
.bar{display:flex;align-items:center;gap:14px;justify-content:space-between;flex-wrap:wrap}
.brand{display:flex;align-items:center;gap:10px}
.logo{width:40px;height:40px;border-radius:50%;background:#fff url('./img/logo.png') center/cover no-repeat;border:2px solid var(--primary)}
.title{font-weight:800} .sub{color:var(--muted);font-size:12px}
.row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid var(--border);
  background:linear-gradient(180deg,var(--soft),color-mix(in hsl, var(--card) 92%, transparent));cursor:pointer;font-weight:700;color:var(--ink)}
.pill:hover{box-shadow:var(--ring)} .pill i{font-style:normal;opacity:.9}
.social{display:flex;gap:6px}
.icon{width:28px;height:28px;border-radius:999px;display:grid;place-items:center;border:1px solid var(--border);
  background:color-mix(in hsl, var(--card) 92%, transparent);font-size:14px;cursor:pointer}
.icon:hover{box-shadow:var(--ring)}
.lang,.themes{display:flex;gap:8px;align-items:center}
.theme{width:28px;height:28px;border-radius:999px;padding:0;border:1px solid var(--border)}
.theme[data-theme="light"]{background:linear-gradient(135deg,#ffbc0d,#ffd861)}
.theme[data-theme="dark"]{background:#333}

/* Hero */
.hero{margin:22px 0;border-radius:var(--radius);padding:22px;
  background:
    radial-gradient(1100px 280px at 8% -40%, color-mix(in hsl, var(--primary) 30%, transparent), transparent 60%),
    radial-gradient(900px 240px at 92% -18%, color-mix(in hsl, var(--accent) 25%, transparent), transparent 60%),
    linear-gradient(135deg, color-mix(in hsl, var(--card) 92%, transparent), color-mix(in hsl, var(--soft) 96%, transparent));
  border:1px solid var(--border)}
.badge{display:inline-block;margin:6px 0 12px;padding:6px 12px;border-radius:999px;background:linear-gradient(90deg,var(--primary),var(--accent));
  color:#111;font-weight:800;letter-spacing:.4px;border:0}
.hero h1{margin:0 0 8px;font-size:clamp(26px,3.8vw,38px)} .hero .muted{color:var(--muted)}
.ctas{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
.btn{border:1px solid var(--border);border-radius:12px;padding:10px 12px;font-weight:800;cursor:pointer}
.btn.primary{background:var(--primary);color:#111;border-color:var(--primary)}
.btn.secondary{background:linear-gradient(90deg,color-mix(in hsl, var(--card) 96%, transparent),var(--soft));color:var(--ink)}

/* Grid */
.tabs{display:flex;gap:10px;flex-wrap:wrap;margin:14px 0 18px}
.tabs .pill.active{box-shadow:var(--ring);border-color:var(--accent)}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:16px}
.card{background:var(--card);border:1px solid var(--border);border-radius:20px;overflow:hidden;display:flex;flex-direction:column;position:relative;box-shadow:0 2px 10px rgba(0,0,0,.04)}
.card .img{aspect-ratio:1/1;background:#f5f5f5 url('./img/pizza.jpg') center/cover no-repeat;content-visibility:auto;contain-intrinsic-size:300px 300px}
.card .body{padding:14px 14px 10px}
.name{font-weight:800} .desc{color:var(--muted);font-size:13px;margin:6px 0 10px;min-height:36px}
.row-sb{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
select,.qty{border:1px solid var(--border);background:color-mix(in hsl, var(--card) 92%, transparent);color:var(--ink);border-radius:12px}
select{padding:8px 10px}
.qty{display:flex;align-items:center;gap:10px;padding:6px 10px}
.qty button{border:none;background:none;color:var(--ink);font-size:18px;cursor:pointer}
.price{font-weight:800;color:var(--accent)}
.tag{position:absolute;left:10px;top:10px;background:var(--accent);color:#fff;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:800}
.btn.add{background:var(--primary);border-color:var(--primary);color:#111}
.btn.add:hover{filter:brightness(1.06)}

/* Carrinho */
.fab{position:fixed;right:18px;bottom:18px;background:#22c55e;color:#062b14;border:none;border-radius:999px;padding:14px 18px;font-weight:900;cursor:pointer;box-shadow:0 10px 25px rgba(34,197,94,.35);z-index:60}
.drawer{position:fixed;inset:0;pointer-events:none;z-index:55}
.drawer.active{pointer-events:auto}
.overlay{position:absolute;inset:0;background:rgba(0,0,0,.35);opacity:0;transition:.2s}
.drawer.active .overlay{opacity:1}
.panel{position:absolute;right:-420px;top:0;height:100svh;width:min(92vw,380px);
  background:var(--card);border-left:1px solid var(--border);transition:.25s;padding:18px;display:flex;flex-direction:column;gap:12px;overflow:auto;-webkit-overflow-scrolling:touch;box-shadow:-24px 0 40px rgba(0,0,0,.06)}
.drawer.active .panel{right:0}
.cart-item{display:grid;grid-template-columns:64px 1fr auto;gap:10px;align-items:center;border-bottom:1px dashed var(--border);padding:8px 0}
.cart-item img{width:64px;height:64px;border-radius:12px;object-fit:cover;background:#0e0e11}
.meta{font-size:12.5px;color:var(--muted)}
.totals{margin-top:auto;border-top:1px solid var(--border);padding-top:10px}
.cta{display:flex;flex-direction:column;gap:10px}
.btn.mail{background:#000;color:#fff;border:1px solid #333}
.btn.wa{background:#25d366;color:#073b16;border:1px solid #0c4}
@media (max-width: 640px){ .panel{ padding-bottom:92px } .cta{ position:sticky; bottom:0; background:var(--card); padding:12px } }

/* Modal */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);padding:16px;z-index:70}
.modal.show{display:flex}
.card-modal{background:var(--card);border-radius:20px;max-width:640px;width:100%;padding:18px;border:1px solid var(--border);color:var(--ink)}
.card-modal h3{margin:0 0 8px}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.grid2 .full{grid-column:1/-1}
input,select,textarea{width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:color-mix(in hsl, var(--card) 94%, transparent);color:var(--ink)}
input:focus,textarea:focus,select:focus{outline:none;box-shadow:var(--ring);border-color:var(--accent)}
.ok{display:none;margin:8px 0 0;padding:10px;border-radius:12px;background:color-mix(in hsl, var(--card) 96%, transparent);border:1px solid var(--border);color:#0a7a0a;font-weight:700}
.ok.show{display:block}

/* Toast */
.toast{position:fixed;left:50%;bottom:90px;transform:translateX(-50%);background:color-mix(in hsl, var(--card) 96%, transparent);border:1px solid var(--border);border-radius:12px;padding:10px 14px;z-index:80;opacity:0;transition:.2s}
.toast.show{opacity:1}

/* RTL */
html[dir="rtl"] .row-sb{flex-direction:row-reverse}
html[dir="rtl"] .tag{left:auto;right:10px}
html[dir="rtl"] .cart-item{grid-template-columns:auto 1fr 64px}
</style>

<script type="application/ld+json">
{"@context":"https://schema.org","@type":"Restaurant","name":"Tasty Pizza & Burger","telephone":"+44 20 8366 6220","address":{"@type":"PostalAddress","streetAddress":"123 Turnpike Lane","postalCode":"N8 0DU","addressCountry":"GB"},"servesCuisine":["Pizza","Burgers"],"priceRange":"¬£"}
</script>
</head>
<body>

<header>
  <div class="container bar">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <div class="title" data-i18n="brand">Tasty Pizza & Burger</div>
        <div class="sub" data-i18n="slogan">Hot. Fresh. Fast.</div>
      </div>
    </div>

    <div class="row">
      <a class="pill" href="tel:+442083866220"><i>üìû</i> 020 8366 6220</a>
      <a class="pill" id="topWhats" target="_blank" rel="noopener"><i>üü¢</i> WhatsApp</a>
      <a class="pill" href="https://maps.google.com/?q=123+Turnpike+Lane,+N8+0DU" target="_blank" rel="noopener"><i>üìç</i> 123 Turnpike Lane, N8 0DU</a>

      <div class="social" aria-label="Social">
        <a class="icon" href="#" title="X">ùïè</a><a class="icon" href="#" title="YouTube">‚ñ∂</a>
        <a class="icon" href="#" title="Instagram">‚óé</a><a class="icon" href="#" title="TikTok">‚ô¨</a>
        <a class="icon" href="#" title="Snapchat">üëª</a>
      </div>

      <div class="themes" aria-label="Theme">
        <button class="theme" data-theme="light" id="theme-light" title="Light" type="button"></button>
        <button class="theme" data-theme="dark" id="theme-dark" title="Dark" type="button"></button>
      </div>
    </div>
  </div>
</header>

<main class="container">
  <section class="hero" aria-labelledby="bfTitle1">
    <span class="badge">BLACK FRIDAY ‚Ä¢ LIMITED TIME</span>
    <h1 id="bfTitle1"><span style="font-size:clamp(34px,6vw,56px);font-weight:800">0%</span> <span style="font-size:clamp(26px,4.5vw,40px);font-weight:800">OFF PIZZAS</span></h1>
    <p class="muted">Limited time only ‚Ä¢ Dine-in, collection or delivery</p>
    <div class="ctas">
      <a class="btn secondary" href="#catalog">See Menu</a>
      <button class="btn primary" id="ctaWhatsTop" type="button">Order on WhatsApp</button>
    </div>
  </section>

  <section class="hero" aria-labelledby="bfTitle2">
    <span class="badge">BLACK FRIDAY ‚Ä¢ LIMITED TIME</span>
    <h1 id="bfTitle2"><span class="gold">Big Deals</span> <span>on Pizza & Burgers</span></h1>
    <p class="muted">Choose size and extras, add to cart and finish via WhatsApp. Pickup or delivery.</p>
    <p class="muted" id="eta" aria-live="polite">Open ‚Ä¢ Delivery ~35‚Äì45 min ‚Ä¢ Pickup ~15 min</p>
  </section>

  <nav class="tabs" id="tabs"></nav>
  <section id="catalog" class="grid" aria-live="polite"></section>
</main>

<button class="fab" id="fabCart" type="button">üõí <span>Cart</span> <span id="fabCount">0</span></button>

<div class="drawer" id="drawer" aria-hidden="true">
  <div class="overlay" id="overlay"></div>
  <aside class="panel" aria-labelledby="cartTitle">
    <h2 id="cartTitle" style="margin:0">Your order</h2>
    <div id="cartList"></div>

    <div class="totals">
      <div class="row-sb"><span>Subtotal</span><strong id="subTotal">¬£0.00</strong></div>
      <div class="row-sb"><span>Service fee</span><strong id="svcFee">¬£0.00</strong></div>
      <div class="row-sb"><span>Delivery fee <small id="distHint" style="color:var(--muted)"></small></span><strong id="delFee">¬£0.00</strong></div>
      <div class="row-sb"><span>Small order fee</span><strong id="smallFee">¬£0.00</strong></div>
      <div class="row-sb"><span>Discount</span><strong id="disc">- ¬£0.00</strong></div>
      <div class="row-sb" style="border-top:1px solid var(--border);padding-top:8px">
        <strong>Total</strong>
        <strong id="cartTotal" aria-live="polite">¬£0.00</strong>
      </div>
      <div class="muted" style="font-size:12px">No online payment ‚Ä¢ Pay on delivery/pickup</div>
    </div>

    <div class="row" style="gap:8px">
      <input id="cupom" placeholder="Coupon (e.g., BLACK10)" style="flex:1">
      <button class="pill" id="applyCupom" type="button">Apply</button>
      <button class="pill" id="clearCupom" type="button">Clear</button>
    </div>

    <div class="cta">
      <button class="btn secondary" id="btnCadastro" type="button">Customer details</button>
      <button class="btn secondary" id="btnClear" type="button">Clear cart</button>
      <button class="btn wa" id="btnWhats" disabled type="button">Finish on WhatsApp</button>
      <button class="btn mail" id="btnEmail" disabled type="button">Send by Email</button>
    </div>
  </aside>
</div>

<!-- MODAL CADASTRO -->
<div class="modal" id="modal" role="dialog" aria-modal="true" aria-labelledby="custTitle" aria-describedby="custHint">
  <div class="card-modal">
    <h3 id="custTitle">Customer details</h3>
    <p class="muted" id="custHint" style="margin-top:-6px">Required to deliver or arrange pickup. No online payment here.</p>
    <form id="custForm" novalidate>
      <div class="grid2">
        <label><span>Name</span><input id="c_nome" placeholder="John Doe" required autocomplete="name"></label>
        <label><span>Phone (WhatsApp)</span><input id="c_tel" type="tel" inputmode="tel" placeholder="+44 7‚Ä¶" required autocomplete="tel"></label>
        <label class="full"><span>Order type</span>
          <select id="c_mode"><option value="delivery">Delivery</option><option value="pickup">Pickup</option></select>
        </label>
        <label><span>Address</span><input id="c_addr" placeholder="Street, number" autocomplete="address-line1"></label>
        <label><span>Postcode</span>
          <div style="display:flex;gap:8px">
            <input id="c_cep" placeholder="N8 0DU" autocomplete="postal-code" style="flex:1">
            <button class="pill" type="button" id="btnCalc">Calcular delivery</button>
          </div>
        </label>
        <label class="full"><span>Notes</span><textarea id="c_obs" rows="3" placeholder="Door code, no onions, etc."></textarea></label>
        <label class="full" style="display:flex;gap:8px;align-items:center"><input id="c_rem" type="checkbox"> <span>Remember my details on this device</span></label>
      </div>
      <div class="row" style="justify-content:space-between;margin-top:12px">
        <button class="pill" id="fecharModal" type="button">Back</button>
        <button class="pill" id="salvarCadastro" type="submit">Save details</button>
      </div>
      <div class="ok" id="okMsg">Saved! üéâ</div>
    </form>
  </div>
</div>

<div class="toast" id="toast" role="status" aria-live="polite"></div>

<footer class="container">
  <p>Prices in GBP. Images illustrative. Black Friday deals while stocks last.</p>
  <p style="font-size:12px">We only store your details locally if you choose ‚ÄúRemember‚Äù. You can clear at any time.</p>
  <p>¬© <span id="y"></span> Tasty Pizza & Burger</p>
</footer>

<script>
/* ===================== CONFIG ===================== */
const STORE = {
  whatsapp: "+447931217826",
  emailPedidos: "orders@tastypizza.co.uk",
  currency: "¬£",
  restaurantPostcode: "N8 0DU",
  // NOVO: pre√ßo por KM (linear)
  ratePerKm: 3.49,
  // Service fee: 5% min 0.49 max 2.00
  serviceFee: { pct: 0.05, min: 0.49, max: 2.00 },
  smallOrder: { threshold: 12.00, fee: 2.00 },
  coupons: { "BLACK10": 0.10 },
  opening: { start: 11, end: 23 }
};
const phoneDigits = STORE.whatsapp.replace(/\D/g,'');
document.getElementById('topWhats').href = `https://wa.me/${phoneDigits}`;
document.getElementById('ctaWhatsTop').addEventListener('click', ()=>safeOpen(`https://wa.me/${phoneDigits}`));

/* ===================== MENU (mesmo de antes ‚Äî resumido aqui) ===================== */
const CATS=["pizzas","burgers","wraps","sides","deals","drinks"];
const MENU={pizzas:[{id:"p-marg",name:"Margherita",desc_en:"Classic tomato & mozzarella.",desc_ar:"ÿµŸÑÿµÿ© ÿ∑ŸÖÿßÿ∑ŸÖ ŸÖÿπ ÿ¨ÿ®ŸÜÿ© ŸÖŸàÿ≤ÿßÿ±ŸäŸÑÿß.",sizes:{'10"':5.99,'12"':7.99,'15"':9.99},tag:"HOT",img:"pizza-margherita.jpg"},{id:"p-pep",name:"Pepperoni",desc_en:"Double pepperoni, mozzarella.",desc_ar:"ÿ®ÿ®ÿ±ŸàŸÜŸä ŸÖÿ≤ÿØŸàÿ¨ ŸÖÿπ ŸÖŸàÿ≤ÿßÿ±ŸäŸÑÿß.",sizes:{'10"':6.99,'12"':8.99,'15"':11.49},img:"pizza-pepperoni.jpg"},{id:"p-meat",name:"Meat Feast",desc_en:"Pepperoni, beef, chicken.",desc_ar:"ÿ®ÿ®ÿ±ŸàŸÜŸä ŸàŸÑÿ≠ŸÖ ÿ®ŸÇÿ±Ÿä ŸàÿØÿ¨ÿßÿ¨.",sizes:{'10"':7.49,'12"':9.99,'15"':12.99},img:"pizza-meatfeast.jpg"},{id:"p-veggie",name:"Vegetarian Hot",desc_en:"Fresh peppers, onion, olives, jalape√±o.",desc_ar:"ŸÅŸÑŸÅŸÑ ÿ∑ÿßÿ≤ÿ¨ Ÿàÿ®ÿµŸÑ Ÿàÿ≤Ÿäÿ™ŸàŸÜ ŸàŸáÿßŸÑÿ®ŸäŸÜŸà.",sizes:{'10"':6.49,'12"':8.49,'15"':10.99},img:"pizza-veg.jpg"}],burgers:[{id:"b-ch",name:"Chicken Burger",desc_en:"Crispy chicken, lettuce, mayo.",desc_ar:"ÿØÿ¨ÿßÿ¨ ŸÖŸÇÿ±ŸÖÿ¥ ŸàÿÆÿ≥ ŸàŸÖÿßŸäŸàŸÜŸäÿ≤.",sizes:{Meal:5.99,Single:4.49},img:"burger-chicken.jpg"},{id:"b-veggie",name:"Veggie Burger",desc_en:"Grilled veggie patty.",desc_ar:"ÿ®ÿ±ÿ∫ÿ± ŸÜÿ®ÿßÿ™Ÿä ŸÖÿ¥ŸàŸä.",sizes:{Meal:5.49,Single:3.99},img:"burger-veggie.jpg"}],wraps:[{id:"w-ch",name:"Chicken Wrap",desc_en:"Chicken, salad, sauce.",desc_ar:"ÿØÿ¨ÿßÿ¨ Ÿàÿ≥ŸÑÿ∑ÿ© ŸàÿµŸàÿµ.",sizes:{Regular:3.99,Meal:5.99},img:"wrap-chicken.jpg"},{id:"w-veg",name:"Vegetable Wrap",desc_en:"Fresh vegetables.",desc_ar:"ÿÆÿ∂ÿßÿ± ÿ∑ÿßÿ≤ÿ¨ÿ©.",sizes:{Regular:3.49,Meal:5.49},img:"wrap-veggie.jpg"}],sides:[{id:"s-fries",name:"Fries",desc_en:"Crispy fries.",desc_ar:"ÿ®ÿ∑ÿßÿ∑ÿ≥ ŸÖŸÇŸÑŸäÿ© ŸÖŸÇÿ±ŸÖÿ¥ÿ©.",sizes:{Small:1.50,Large:2.50},img:"side-fries.jpg"},{id:"s-onion",name:"Onion Rings (10)",desc_en:"Golden rings.",desc_ar:"ÿ≠ŸÑŸÇÿßÿ™ ÿ®ÿµŸÑ ÿ∞Ÿáÿ®Ÿäÿ©.",sizes:{Box:2.99},img:"side-onionrings.jpg"}],deals:[{id:"d-meal1",name:"Meal 1",desc_en:'Any 10" pizza + garlic bread + drink',desc_ar:'ÿ£Ÿä ÿ®Ÿäÿ™ÿ≤ÿß ÿ≠ÿ¨ŸÖ 10" + ÿÆÿ®ÿ≤ ÿ®ÿßŸÑÿ´ŸàŸÖ + ŸÖÿ¥ÿ±Ÿàÿ®',sizes:{Deal:12.50},tag:"BF DEAL",img:"deal-meal1.jpg"},{id:"d-meal2",name:"Meal 2",desc_en:'2x 12" pizza + 1.5L drink',desc_ar:'2 ÿ®Ÿäÿ™ÿ≤ÿß 12" + ŸÖÿ¥ÿ±Ÿàÿ® 1.5 ŸÑÿ™ÿ±',sizes:{Deal:17.00},img:"deal-meal2.jpg"}],drinks:[{id:"dr-15coke",name:"Coke/Pepsi 1.5L",desc_en:"Cold.",desc_ar:"ÿ®ÿßÿ±ÿØ.",sizes:{Bottle:3.00},img:"drink-15l.jpg"},{id:"dr-can",name:"Can 330ml",desc_en:"Various flavours.",desc_ar:"ŸÜŸÉŸáÿßÿ™ ŸÖÿ™ÿπÿØÿØÿ©.",sizes:{Can:1.10},img:"drink-can.jpg"}]};

/* ===================== HELPERS ===================== */
function money(n){const v=Number(n)||0;return `${STORE.currency}${v.toFixed(2)}`;}
function safeOpen(url){const w=window.open(url,'_blank','noopener');if(w)w.opener=null;}
function showToast(t){const x=document.getElementById('toast');x.textContent=t;x.classList.add('show');setTimeout(()=>x.classList.remove('show'),1200);}
function haversineKm(lat1,lon1,lat2,lon2){const R=6371;const toRad=d=>d*Math.PI/180;const dLat=toRad(lat2-lat1);const dLon=toRad(lon2-lon1);const a=Math.sin(dLat/2)**2+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));}

/* ===================== RENDER ===================== */
const elTabs=document.getElementById('tabs'), elCatalog=document.getElementById('catalog');
function makeTabs(){elTabs.innerHTML='';["Pizzas","Burgers","Wraps","Sides","Deals","Drinks"].forEach((t,i)=>{const b=document.createElement('button');b.type='button';b.className='pill'+(i===0?' active':'');b.textContent=t;b.dataset.cat=CATS[i];b.addEventListener('click',()=>{elTabs.querySelectorAll('.pill').forEach(x=>x.classList.remove('active'));b.classList.add('active');renderCat(b.dataset.cat);});elTabs.appendChild(b);});}
function renderCat(catKey){elCatalog.innerHTML='';(MENU[catKey]||[]).forEach(item=>{const card=document.createElement('article');card.className='card';const bg=item.img?`style="background-image:url('./img/${item.img}'),linear-gradient(#f5f5f5,#f5f5f5)"`:'';card.innerHTML=`<div class="img" ${bg} role="img" aria-label="${item.name}"></div>${item.tag?`<span class="tag">${item.tag}</span>`:''}<div class="body"><div class="name">${item.name}</div><div class="desc">${item.desc_en}</div><div class="row-sb"><label><span>Size</span>:<select aria-label="Size">${Object.entries(item.sizes).map(([k,v])=>`<option value="${v}">${k} ‚Äî ${money(v)}</option>`).join('')}</select></label><div class="qty" aria-label="Qty"><button class="minus" type="button" aria-label="Decrease quantity">‚àí</button><span class="q">1</span><button class="plus" type="button" aria-label="Increase quantity">+</button></div></div><div class="row-sb" style="margin-top:8px"><div class="price">from ${money(Math.min(...Object.values(item.sizes)))}</div><button class="btn add" data-id="${item.id}" type="button">Add</button></div></div>`;const qty=card.querySelector('.qty');qty.addEventListener('click',e=>{const span=qty.querySelector('.q');let q=parseInt(span.textContent,10);if(e.target.classList.contains('minus'))q=Math.max(1,q-1);if(e.target.classList.contains('plus'))q=q+1;span.textContent=q;});card.querySelector('.add').addEventListener('click',()=>{const sizeSel=card.querySelector('select');const price=parseFloat(sizeSel.value);const sizeName=sizeSel.options[sizeSel.selectedIndex].text.split(' ‚Äî ')[0];const q=parseInt(card.querySelector('.q').textContent,10);state.cart.push({id:item.id,name:item.name,desc:item.desc_en,size:sizeName,price,q,img:item.img||'pizza.jpg'});renderCart();openDrawer();showToast('Item added to cart');});elCatalog.appendChild(card);});}

/* ===================== CART + FEES ===================== */
const drawer=document.getElementById('drawer'),overlay=document.getElementById('overlay'),fab=document.getElementById('fabCart');
const btnClear=document.getElementById('btnClear'),btnWhats=document.getElementById('btnWhats'),btnEmail=document.getElementById('btnEmail'),btnCadastro=document.getElementById('btnCadastro');
const elSubTotal=document.getElementById('subTotal'),elDelFee=document.getElementById('delFee'),elDisc=document.getElementById('disc'),elTotal=document.getElementById('cartTotal'),elSvc=document.getElementById('svcFee'),elSmall=document.getElementById('smallFee'),elCupom=document.getElementById('cupom'),fabCount=document.getElementById('fabCount'),distHint=document.getElementById('distHint');
const state={cart:JSON.parse(localStorage.getItem('cart')||'[]'),cadastro:JSON.parse(localStorage.getItem('cust')||'null'),coupon:localStorage.getItem('coupon')||'',rest:{lat:null,lon:null},lastKm:null};
if(state.coupon)elCupom.value=state.coupon;

function openDrawer(){drawer.classList.add('active');drawer.setAttribute('aria-hidden','false');}
function closeDrawer(){drawer.classList.remove('active');drawer.setAttribute('aria-hidden','true');}
overlay.addEventListener('click',closeDrawer);fab.addEventListener('click',openDrawer);

function computeServiceFee(subtotal){const {pct,min,max}=STORE.serviceFee;const v=Math.min(Math.max(subtotal*pct,min),max);return +v;}
function computeSmallOrder(subtotal){const {threshold,fee}=STORE.smallOrder;return subtotal>0&&subtotal<threshold?fee:0;}

function computeDeliveryLinear(){
  if(!(state.cadastro&&state.cadastro.geo&&state.rest.lat!=null)) return {fee:0,km:null};
  const km=haversineKm(state.rest.lat,state.rest.lon,state.cadastro.geo.lat,state.cadastro.geo.lon);
  const fee = Math.max(0, +(km*STORE.ratePerKm).toFixed(2));
  state.lastKm = km;
  return {fee,km};
}

function computeFees(){
  const subtotal=state.cart.reduce((s,it)=>s+it.price*it.q,0);
  const svc=computeServiceFee(subtotal);
  const small=computeSmallOrder(subtotal);
  const {fee:del,km}=computeDeliveryLinear();
  distHint.textContent = km?`(${km.toFixed(2)} km √ó ¬£${STORE.ratePerKm.toFixed(2)}/km)`:'';
  return {subtotal,svc,del,small};
}

function computeDiscount(subtotal){const code=(state.coupon||'').toUpperCase().trim();const pct=STORE.coupons[code]||0;return {code,pct,value:+(subtotal*pct)};}

function renderCart(){
  const list=document.getElementById('cartList');list.innerHTML='';
  state.cart.forEach((it,idx)=>{const row=document.createElement('div');row.className='cart-item';row.innerHTML=`<img alt="${it.name}" src="./img/${it.img}" loading="lazy" decoding="async"><div><div style="font-weight:800">${it.name}</div><div class="meta">${it.size} ‚Ä¢ Qty: ${it.q} ‚Ä¢ ${money(it.price)} ea</div></div><button class="btn" style="padding:8px" type="button" aria-label="Remove">‚úï</button>`;row.querySelector('button').addEventListener('click',()=>{state.cart.splice(idx,1);renderCart();showToast('Item removed');});list.appendChild(row);});
  localStorage.setItem('cart',JSON.stringify(state.cart));
  fabCount.textContent=state.cart.reduce((a,b)=>a+b.q,0);

  const {subtotal,svc,del,small}=computeFees();
  const discObj=computeDiscount(subtotal); const discount=Math.min(discObj.value,subtotal);
  const total=Math.max(subtotal+svc+del+small-discount,0);

  elSubTotal.textContent=money(subtotal);
  elSvc.textContent=money(svc);
  elDelFee.textContent=money(del);
  elSmall.textContent=small?money(small):'¬£0.00';
  elDisc.textContent=`- ${money(discount)}`;
  elTotal.textContent=money(total);

  const enabled=state.cart.length>0 && !!state.cadastro;
  btnWhats.disabled=!enabled; btnEmail.disabled=!enabled;
}
btnClear.addEventListener('click',()=>{state.cart=[];localStorage.removeItem('cart');renderCart();});

document.getElementById('applyCupom').addEventListener('click',()=>{const code=elCupom.value.trim().toUpperCase();if(!code){state.coupon='';localStorage.removeItem('coupon');renderCart();return;}if(!(code in STORE.coupons)){showToast('Invalid coupon');return;}state.coupon=code;localStorage.setItem('coupon',code);renderCart();showToast(`Coupon ${code} applied`);});
document.getElementById('clearCupom').addEventListener('click',()=>{state.coupon='';localStorage.removeItem('coupon');elCupom.value='';renderCart();});

/* ===== Texto do pedido (com quebra de linha garantida) ===== */
function montarTextoPedido(){
  const itens=state.cart.map(it=>`‚Ä¢ ${it.name} (${it.size}) x${it.q} ‚Äî ${money(it.price)} ea`).join('\n');
  const {subtotal,svc,del,small}=computeFees();const discObj=computeDiscount(subtotal);const discount=Math.min(discObj.value,subtotal);
  const total=Math.max(subtotal+svc+del+small-discount,0);
  const c=state.cadastro||{};
  const kmTxt = state.lastKm? ` (${state.lastKm.toFixed(2)} km √ó ¬£${STORE.ratePerKm.toFixed(2)}/km)` : '';
  const feesBlock=['',`Subtotal: ${money(subtotal)}`,`Service fee: ${money(svc)}`,`Delivery fee: ${money(del)}${kmTxt}`,small?`Small order fee: ${money(small)}`:'',`Discount${discObj.code?` (${discObj.code})`:''}: - ${money(discount)}`,`Total: ${money(total)}`].filter(Boolean).join('\n');
  const cli=['',`Customer: ${c.nome||'-'}`,`WhatsApp: ${c.tel||'-'}`,`Type: ${c.mode||'-'}`,`Address: ${c.addr||'-'}`,`Postcode: ${c.cep||'-'}`,`Notes: ${c.obs||'-'}`].join('\n');
  const ref=Date.now().toString().slice(-6);
  return `Order via Black Friday menu\n\nItems:\n${itens}${feesBlock}${cli}\nRef:${ref}`;
}
function waUrl(text){const max=1900;const msg=text.length>max?(text.slice(0,max-1)+'‚Ä¶'):text;return `https://wa.me/${phoneDigits}?text=${encodeURIComponent(msg)}`;}
btnWhats.addEventListener('click',()=>safeOpen(waUrl(montarTextoPedido())));
btnEmail.addEventListener('click',()=>{const assunto=`Order ‚Äî Tasty Pizza`;const corpo=montarTextoPedido();const url=`mailto:${STORE.emailPedidos}?subject=${encodeURIComponent(assunto)}&body=${encodeURIComponent(corpo)}`;window.location.href=url;});

/* ===================== MODAL CADASTRO + POSTCODES.IO ===================== */
const modal=document.getElementById('modal'),btnFechar=document.getElementById('fecharModal'),okMsg=document.getElementById('okMsg');
function fillCadastro(){const c=state.cadastro||{};c.nome&&(document.getElementById('c_nome').value=c.nome);c.tel&&(document.getElementById('c_tel').value=c.tel);document.getElementById('c_mode').value=c.mode||'delivery';c.addr&&(document.getElementById('c_addr').value=c.addr);c.cep&&(document.getElementById('c_cep').value=c.cep);c.obs&&(document.getElementById('c_obs').value=c.obs);document.getElementById('c_rem').checked=!!localStorage.getItem('cust');}
function closeModal(){modal.classList.remove('show');document.removeEventListener('keydown',trapKeys);} function openModal(){fillCadastro();modal.classList.add('show');document.getElementById('c_nome').focus();document.addEventListener('keydown',trapKeys);} function trapKeys(e){if(e.key==='Escape')closeModal();}
document.getElementById('btnCadastro').addEventListener('click',openModal); btnFechar.addEventListener('click',closeModal);

async function lookupPostcode(pc){
  const clean=pc.toUpperCase().trim().replace(/\s+/g,'');
  if(!clean) return null;
  try{
    const r=await fetch(`https://api.postcodes.io/postcodes/${encodeURIComponent(clean)}`);
    const j=await r.json();
    if(j.status!==200) return null;
    return j.result; // {postcode, latitude, longitude, ...}
  }catch(e){return null;}
}

async function geocodeAndCalc() {
  const cepRaw=document.getElementById('c_cep').value.trim();
  const info=await lookupPostcode(cepRaw);
  if(!info){ showToast('Invalid postcode'); return; }
  document.getElementById('c_cep').value=info.postcode;
  state.cadastro = state.cadastro || {};
  state.cadastro.geo = { lat: info.latitude, lon: info.longitude };
  renderCart();
  if(state.lastKm!=null) showToast(`Dist√¢ncia: ${state.lastKm.toFixed(2)} km ‚Ä¢ Delivery ¬£${(state.lastKm*STORE.ratePerKm).toFixed(2)}`);
}

document.getElementById('btnCalc').addEventListener('click', geocodeAndCalc);

document.getElementById('custForm').addEventListener('submit',async (e)=>{
  e.preventDefault();
  const nome=document.getElementById('c_nome').value.trim();
  const tel=document.getElementById('c_tel').value.trim();
  const mode=document.getElementById('c_mode').value;
  const addr=document.getElementById('c_addr').value.trim();
  const cepRaw=document.getElementById('c_cep').value.trim();
  const rawObs=document.getElementById('c_obs').value;
  const obs=rawObs.replace(/\s+/g,' ').replace(/\b(\w+)(\s*\1)+\b/gi,'$1').trim();
  if(!nome || !tel){ alert('Name and phone are required.'); return; }

  let cepFmt=cepRaw, geo=state.cadastro && state.cadastro.geo ? state.cadastro.geo : null;
  if(!geo){
    const info=await lookupPostcode(cepRaw);
    if(info){ cepFmt=info.postcode; geo={lat:info.latitude,lon:info.longitude}; }
  }
  const c={nome,tel,mode,addr,cep:cepFmt,obs,geo};
  state.cadastro=c;
  if(document.getElementById('c_rem').checked){ localStorage.setItem('cust',JSON.stringify(c)); } else { localStorage.removeItem('cust'); }
  okMsg.classList.add('show'); setTimeout(()=>{ okMsg.classList.remove('show'); closeModal(); renderCart(); },800);
});

/* ===================== HOR√ÅRIO ===================== */
function opStatus(){const now=new Date();const h=now.getHours();const open=h>=STORE.opening.start&&h<STORE.opening.end;document.getElementById('eta').textContent=open?'Open ‚Ä¢ Delivery ~35‚Äì45 min ‚Ä¢ Pickup ~15 min':'Closed now ‚Ä¢ Pre-order available';}
setInterval(opStatus,60_000);

/* ===================== THEME ===================== */
const savedTheme=localStorage.getItem('theme')||'light';document.documentElement.setAttribute('data-theme',savedTheme);
document.getElementById('theme-light').addEventListener('click',()=>{document.documentElement.setAttribute('data-theme','');localStorage.setItem('theme','light');});
document.getElementById('theme-dark').addEventListener('click',()=>{document.documentElement.setAttribute('data-theme','dark');localStorage.setItem('theme','dark');});

/* ===================== INIT ===================== */
document.getElementById('y').textContent=new Date().getFullYear();
(async function(){
  const r=await lookupPostcode(STORE.restaurantPostcode);
  if(r){ state.rest.lat=r.latitude; state.rest.lon=r.longitude; }
  makeTabs(); renderCat(CATS[0]); renderCart(); opStatus();
})();
</script>
</body>
</html>
